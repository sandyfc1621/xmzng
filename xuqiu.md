需求背景：开发一个营运系统用来对接小麦智能售货柜，要有管理后台和智能售货柜小程序两部分。营运系统后台要包含以下功能：用户管理、门店管理、智能售货柜设备管理、商品管理、订单管理、异常订单管理、投诉订单管理、智能柜零售查询、智能柜商品销量统计、销售报表。智能柜小程序要有扫码开门功能、订单、订单投诉三个模块。  

# 营运系统管理后台  

后台各个功能模块如下：  

# 一 用户管理  

界面如下图，有用户信息列表，以及添加、编辑、删除、查询功能。  

# 用户管理  

![](images/1.png)

1.用户列表 列包含：用户名、姓名、手机号、创建时间、操作；  

2.点击【添加用户】弹出添加用户的页面，需要填写的字段有：用户名、密码、姓名、手机号；  

![](images/2.png)  

3.点击操作列的【编辑】，打开用户编辑页面，如下图，可以修改用户名、姓名、手机号、密码；  

![](images/3.png)  

4.点击操作列的【删除】按钮，可以删除该列的用户；  

# 二 门店管理  

门店管理功能包括门店列表、新增门店、导入、查询功能。门店列表包含列：门店编码、门店名称、门店地址、门店电话、门店种类、门店属性。门店种类有：儿童、电玩、运动馆。门店属性有：直营、加盟。  

门店管理界面如下图：  

![](images/4.png) 

点击【新增门店】界面如下图：  

![](images/5.png) 

# 三 智能售货柜管理  

界面大致如下图所示，包含设备列表、同步设备、绑定门店、生成下单码，以及筛选条件。  

![](images/6.png) 

界面功能点说明：  

1.同步设备：点击【同步设备】从小麦的接口获取设备列表以及在线状态；  

2.设备列表包含的列分别是：设备号、在线状态、绑定门店、操作；  
3.点击【绑定门店】，弹出选择门店的页面，绑定后在【绑定门店】列显示对应的门店；多个设备可以绑定同一个门店；  
4.已经绑定门店的设备点击【生成下单码】可以生成该设备对应的小程序码，没有绑定门店的不能生成下单码，提示：请先绑定门店；  
5.查询条件：可按设备号、门店名称、在线状态筛选。  

# 四 商品管理  

在ERP 系统创建好商品，再从ERP 系统同步到营运系统管理后台。  
界面如下图，包含商品列表、同步商品，以及筛选功能。  

![](images/7.png) 

功能点说明：  

1.点击【同步商品】从ERP 系统的接口获取物料信息，写入到商品列表；  
2.列表包含的列，分别是：物料编码、条形码、物料名称、小麦商品ID、物料类型；  
3.查询条件:可按物料编码/条形码/小麦商品ID 以及物料名称筛选；  

# 五 订单管理  

用户在小程序下单后，会生成订单，订单信息显示在订单列表。因为智能售货柜可能出现识别错误导致订单错误的问题，所以订单支持修正，并且订单金额遵循多退少补的原则。  

# 1.订单列表  

界面如下图所示，能根据门店查看各个门店的订单、能按筛选条件查询订单。  

![](images/8.png)  

订单有2 种支付方式：微信支付和礼票支付。  

界面功能点说明：  

1.订单列表要包含的列分别是：订单号、设备号、会员手机号、订单金额、支付方式、微信支付金额、礼票支付数量、下单门店、下单时间、付款时间、付款状态、小麦订单号、备注；  

2.支付方式有2 种，分别是：微信、礼票。如果支付方式是微信，则【微信支付金额】列显示对应的金额，【礼票支付数量】列显示0，如果是礼票支付方式，则【礼票支付】列显示订单所扣的礼票数量，【微信支付金额】列显示0；  

3.点击【订单号】列下面的订单号，跳转到【订单详情】页面；  

4.【备注】列：已修正过的订单显示：已修正订单，通过修正订单生成的补扣订单，显示：补扣订单，既不是修正过的订单也不是补扣订单则为空。  

# 2.订单详情  

订单详情界面如下图，显示订单内的商品以及对应数量、金额等，能查看下单视频以及修正订单。   

![](images/9.png)  

界面功能点说明：  

1.查看下单视频：点击【查看下单视频】能打开小麦智能货柜的下单视频链接；  

2.每个订单只能修正1 次。未修正的订单，点击【修正订单】跳转到【修正订单页面】，能调整商品数量，也能添加商品，界面如后面的【3.修正订单页面】；已修正的订单或者新生成的补扣订单点击修正订单，提示：订单已修正过，不支持再次修正；  

# 3.修正订单页面  

点击【修正订单】跳转到修正订单页面，界面如下图：  

![](images/10.png)  

界面功能点说明：  

1.【修正订单页面】可以调整订单的商品数量，如当前数量2，调整数量填3，则调整后数量为5；若当前数量2，调整数量填-1，则调整后数量为1；  
2.根据填写的调整数量自动计算【调整金额/礼票数量】，如果支付方式为微信支付，【调整金额/礼票数量】 $\mathbf{\sigma}=\mathbf{\sigma}$ 商品价格\*调整数量；如果支付方式是礼票支付，【调整金额/礼票数量】 $\mathbf{\sigma}=\mathbf{\dot{\sigma}}$ 商品价格\*调整数量 $^{*}500$ ；  
3.如果智能柜识别少了商品，那么订单就要添加商品，点击【请选择商品】选择要添加的商品，填写数量，然后点击【添加】，添加的商品显示到修正商品列表，添加的商品当前数量为0，调整数量为刚刚添加商品填写的数量；  
4.最后点击【确定】则修正完成，按照修正内容生成补扣订单。订单修正后不改变原来的订单，按照多退少补的原则生成一个新的补扣订单，新的补扣订单支付方式和原订单保持一致。如果是多扣了钱或彩票，直接原路退回多扣的钱或彩票，同时生成负数订单。如果是少扣了钱，生成新的待支付订单，如果是少扣了彩票，直接扣顾客的彩票，同时生成一个新的彩票支付订单。  
5.修正过的订单或者补扣订单，订单详情界面如下图，会显示关联订单号，即补扣订单的订单号或者修正过的订单号，点击关联的订单号调整到对应的订单详情页。  

![](images/11.png)

# 六 异常订单  

界面如下图，异常订单是通过小麦的接口传过来的带有【异常】状态的订单，单独做一个异常订单列表。能根据门店查看并处理各个门店的异常订单。  

![](images/12.png)  

界面功能点说明：  

1.异常订单列表包含的列有：订单号、设备号、门店名称、会员手机号、订单金额、支付方式、微信支付金额、礼品支付数量、下单时间、付款时间、付款状态、小麦订单号、处理状态。

2 异常订单来源：通过小麦接口传过来的订单状态为【异常】的订单，可能是识别不清楚或者有未上架到智能售货柜的商品，需要人工干预修正订单。没有处理过的订单默认的处理状态为：未处理；

3.点击订单号可以跳转到对应的订单详情页面，点击处理状态为【未处理】的订单跳转到订单详情页面，再从订单详情页面去点击【修正订单】跳转到修正订单页面去调整商品数量。  

4.已修正的订单，异常订单的处理状态变成【已处理】。  

# 七 投诉订单  

投诉订单来源：1.在智能柜小程序里面对订单申请售后会生成投诉订单；2.通过微信支付页面投诉生成的投诉订单；  

# 1.投诉订单列表页面  

投诉订单列表页面如下图：  

![](images/13.png)  

1.投诉订单列表列名分别是：投诉编号、门店、设备号、订单号、手机号、问题描述、投诉来源、处理状态、提交时间、操作；  

2.投诉来源有2 个，分别是：小程序、微信  

3.点击操作列的【查看详情】跳转到订单详情页面。  

# 2.投诉订单的订单详情页面  

投诉订单的详情页面如下图：上面显示订单详情内容，下面显示投诉内容 。 

![](images/14.png)  

界面功能点说明：  

1.投诉订单的订单详情页可以增加显示：投诉处理记录，也能回复投诉；  
2.投诉人第一次投诉的内容包括投诉内容，以及申请退款金额，申请退款金额写在括号内；  

# 3.投诉订单详情页回复投诉  

投诉订单详情页点击【去回复】弹框回复页面如下图：  

![](images/15.png)   

界面说明：  

1.点击【去回复】，弹出回复内容的弹窗，填写回复内容，并选择处理状态，处理状态默认是处理中，如果已经处理完，选择已处理，再点击【提交】，顾客可以在小程序或者微信支付投诉处查看回复内容，同时订单详情页记录回复内容。  

# 八 智能柜零售查询  

智能柜零售查询主要是商品出售明细表。界面如下图所示，能根据下单时间、支付类型及门店查询订单的商品出售明细。  

![](images/16.png)  

界面功能点说明：  

1.商品出售明细表的列名有：门店名称、商品名称、物料编码、数量、微信支付金额、礼票支付数量、  

下单时间、支付状态；  

2.查询条件有：下单时间、支付方式、门店名称，物料编码/商品名称。  

# 九 智能柜商品销量统计  

智能柜商品销量统计主要是根据门店统计各个商品的销售数量、微信支付金额、彩票支付数量。界面如下图：  

![](images/17.png)  

界面功能点说明：  

1.能根据门店统计不同下单时间段内的各个商品的销售数量，以及对应的微信支付金额、礼票支付数量；  
2.页面底部汇总销售数量、微信支付金额、彩票支付数量。  

# 十 销售报表  

销售报表只统计支付方式是【微信支付】的订单  

1.销售报表包含的列有：订单标号、银联交易号、购买门店、实付金额、商品名称、销售类型、支付方式、付款状态、购买时间、付款时间。筛选条件有：订单编号、购买门店、商品名称、银联交易号、下单时间、付款状态。  

# 智能柜小程序  

智能柜小程序包括三大模块：扫码开门、订单、订单投诉，以下是各个模块的具体内容。  

# 一 扫码开门  

扫码开门有以下2 个方式  

第一个方式：顾客用微信扫一扫功能扫描贴在智能售货柜上面的门店下单码进入【智能柜小程序】，因为门店下单码已经带有智能柜的设备号，所以进入小程序后，首页显示【开门】按钮，界面如下如，点击【开门】，直接触发后续的验证步骤；  

![](images/7b169d37c902f726090bf68a6a701ffd64a1783a16ba4392f91084e19ce84661.jpg)  

第二个方式：先从微信直接进入智能柜小程序，这种方式进入小程序没有带智能柜的设备号，所以首页显示的是【扫码开门】按钮，如下图，点【扫码开门】打开微信的扫一扫功能，然后扫描贴在智能柜上的门店下单码，进入后续的验证步骤。  

![](images/33bc75af0bc8e0f7f4f856d9339a1cd13434396b707a247a4124c479ca821dd8.jpg)  

# 触发【开门】后的验证步骤：  

1.获取手机号并登录小程序：如果用户没有登录智能柜小程序，触发【开门】后，弹出是否允许获取手机号的弹框，如下图，选择允许获取手机号后进入进入下一个步骤；如果顾客已经登录了小程序，跳过这一步直接进入下一个步骤；  

![](images/9ab3e865f6c00f12067106e43495cc6658bf1584ebf08772e70990c35becd62f.jpg)  

2.判断当前用户是否存在待支付订单：用户触发开门并且登录小程序后，判断当前用户是否有待支付订单，如果有待支付订单，页面弹出提示：您存在待支付订单，请先支付再购物！  

3.判断当前用户的可用礼票数是否大于10000：如果当前用户的礼票数小于10000，则调用微信的接口弹出是否同意授权微信支付分的页面，同意授权则调用小麦的接口开门；如果礼票数大于10000，则跳转到支付方式选择页面，可以选择微信支付或者礼票支付，界面如下，如果点击【微信支付】，则调用微信的接口弹出是否同意授权微信支付分的页面，同意授权则调用小麦的接口开门，如果选择【礼票支付】，则调用小麦的接口开门；  

![](images/a9212ce8b73d6796bd3c12c5829e0d32ec97586d2a5e6dbf22333798c7969e11.jpg)  

4.开门购物并关门：请求小麦的接口打开智能柜的门后，同时小程序页面会显示：开锁成功，请拉门购物，这时用户可以选购需要的商品，然后开门，这时小麦的接口会推送购物订单给营运系统，小麦订单内容包含：小麦订单号、商品名称、商品单价、数量、下单视频链接等。通过小麦接口传回来的订单生成营运系统的订单，订单包括：订单号、智能柜设备号、会员手机号、订单金额、支付方式、微信支付金额、礼票支付数量、下单时间、付款时间、小麦订单号，并从用户的微信扣钱或者扣用户的礼票数量，如果是微信支付的订单扣订单对应的金额，如果是礼票支付订单，需要扣的礼票数量 $\mathbf{\Psi}=\mathbf{\vec{\tau}}$ 订单金额 $^{*}500_{\mathrm{c}}$ 。  

![](images/556474d8c4337cd3dc49dbe9af5f46c67ff99c0a50cd05bdd5670ddcbb3413cc.jpg)  

![](images/35885b460212b713f6df1aa9732d2095815907a43a0daf1d7ccf951f08c330b5.jpg)  

1.点击首页的图标【我的】跳转到我的页面，再点击【我的订单】进入订单列表；  
2.订单列表按订单生成的时间倒序显示，订单信息包含：门店、商品图片、商品名称、数量、总金额，礼票支付数等；  
3.点击订单进入订单详情页面，微信支付的订单【合计】显示微信支付金额，礼票支付的订单【合计】显示礼票支付数；  
4.修正过的订单，门店前面显示【修正订单】，订单内容不变，修正后产生的新订单，门店前面显示【补扣订单】。  
三 订单投诉  

![](images/de7a3aea1b15fe47d1a406bb3d2d459ac4630c6b605884e2ce3800edf98fb050.jpg)  

1.每个订单只允许申请售后一次，没有申请过售后的订单，订单详情页面点击【申请售后】，进入售后页面，已经申请过售后的订单，订单详情页不显示申请售后，只显示【查看售后详情】；2.点击【申请售后】进入售后页面，需填写：申请退款金额、申请原因，以及问题描述，联系电话默认显示当前用户的手机号，也可以修改，点击【提交】后进入【售后详情】页面；3.还未处理过的售后订单，售后详情页面默认回复：您的反馈我们已经收到，将在三天内处理，请耐心等待。顾客可以主动留言，营运系统后台可以看到顾客的投诉以及留言，商家的处理结果以及回复内容可以在售后详情页面查看。  

# 异常处理方案

## 一、订单异常处理
### 1. 订单推送失败处理
1.重试机制
- 最大重试3次
- 重试间隔分别为15秒、30秒、60秒
- 超过最大重试次数后，转人工处理
2.异常记录
- 记录每次失败原因
- 记录重试次数和时间
- 保存原始订单数据
### 2. 订单金额异常处理
1.异常判定标准
- 单笔订单金额超过1000元
- 单笔订单金额小于0.1元
- 同一用户短时间内多笔大额订单
2.处理措施
- 自动拦截异常订单
- 记录异常订单信息
## 二、支付异常处理
### 1. 礼票支付失败处理
1.失败原因分类
- 网络通信故障
- 支付接口异常
- 账户异常
- 系统处理超时
2.处理流程
- 自动重试支付
- 记录失败原因
## 三、设备异常处理
### 1. 开门失败处理
1.失败原因分析
- 通信故障
- 硬件故障
- 权限问题
- 系统异常
2.处理方案
- 自动重试开门
- 记录失败原因


